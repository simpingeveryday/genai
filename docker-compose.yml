version: '3.8'

services:
  # 1. The Database (Runs on Server)
  db:
    image: mysql:8.0
    container_name: loan_mysql_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: hoising123
      MYSQL_DATABASE: bank_loan_system
    volumes:
      # Persist data on the server
      - db_data:/var/lib/mysql
      # Initialize tables on first run
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - loan_network

  # 2. Your App (Runs on Server)
  app:
    image: my-loan-app:v1
    # build: .
    container_name: loan_processor_app
    depends_on:
      - db
    ports:
      - "8501:8501"
    environment:
      # Connect to the 'db' container internally
      DB_HOST: db
      # Connect to your PC externally
      STREAMLIT_SERVER_BASE_URL_PATH: 'loan_app'
      STREAMLIT_SERVER_ENABLE_CORS: 'false'
      STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION: 'false'
      STREAMLIT_SERVER_MAX_UPLOAD_SIZE: '200'
      # REPLACE WITH YOUR PC'S PUBLIC IP OR TAILSCALE IP
      OLLAMA_BASE_URL: http://192.168.1.102:11434 
    # volumes:
      # We still need persistence for the ChromaDB vector stores
      # - ./chroma_db_risk:/app/chroma_db_risk
      # - ./chroma_db_interest:/app/chroma_db_interest
      # Bind mount the PDFs so you can replace them easily
      # - "./Bank Loan Overall Risk Policy.pdf:/app/Bank Loan Overall Risk Policy.pdf"
      # - "./Bank Loan Interest Rate Policy.pdf:/app/Bank Loan Interest Rate Policy.pdf"
    networks:
      - loan_network

volumes:
  db_data:

networks:
  loan_network:
